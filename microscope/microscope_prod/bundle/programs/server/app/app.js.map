{"version":3,"sources":["meteor://üíªapp/lib/permissions.js","meteor://üíªapp/lib/router.js","meteor://üíªapp/collections/comments.js","meteor://üíªapp/collections/posts.js","meteor://üíªapp/server/fixtures.js","meteor://üíªapp/server/publications.js","meteor://üíªapp/server/qiniu.js","meteor://üíªapp/server/startup.js","meteor://üíªapp/server/utils.js"],"names":[],"mappings":"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","file":"/app.js","sourcesContent":["// check that the userId specified owns the documents\r\nownsDocument = function(userId, doc) {\r\n\treturn doc && doc.userId === userId;\r\n}","Router.configure({\r\n\tlayoutTemplate: 'layout',\r\n\tloadingTemplate: 'loading',\r\n\tnotFoundTemplate: 'notFound',\r\n\twaitOn: function() {\r\n\t\treturn Meteor.subscribe('posts');\r\n\t}\r\n});\r\n\r\nRouter.route('/', {name: 'postsList'});\r\nRouter.route('/posts/:_id', {\r\n\tname: 'postPage',\r\n\twaitOn: function() {\r\n\t\treturn Meteor.subscribe('comments', this.params._id);\r\n\t},\r\n\tdata: function() { return Posts.findOne(this.params._id); }\r\n});\r\n\r\nvar requireLogin = function() {\r\n\tif (! Meteor.user()) {\r\n\t\t\tif (Meteor.loggingIn()) {\r\n\t\t\t\tthis.render(this.loadingTemplate);\r\n\t\t\t} else {\r\n\t\t\t\tthis.render('accessDenied');\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis.next();\r\n\t}\r\n}\r\n\r\nRouter.route('/posts/:_id/edit', {\r\n\tname: 'postEdit',\r\n\tdata: function() { return Posts.findOne(this.params._id); }\r\n})\r\n\r\nRouter.route('/submit', {name: 'postSubmit'});\r\nRouter.onBeforeAction('dataNotFound', {only: 'postPage'});\r\nRouter.onBeforeAction(requireLogin, {only: 'postSubmit'});","Comments = new Mongo.Collection('comments');\r\n\r\nMeteor.methods({\r\n\tcommentInsert: function(commentAttributes) {\r\n\tcheck(this.userId, String);\r\n\tcheck(commentAttributes, {\r\n\t\tpostId: String,\r\n\t\tbody: String\r\n\t});\r\n\tvar user = Meteor.user();\r\n\tvar post = Posts.findOne(commentAttributes.postId);\r\n\tif (!post)\r\n\t\tthrow new Meteor.Error('invalid-comment', 'You must comment on a post');\r\n\tcomment = _.extend(commentAttributes, {\r\n\t\tuserId: user._id,\r\n\t\tauthor: user.username,\r\n\t\tsubmitted: new Date()\r\n\t});\r\n\t// Êõ¥Êñ∞Â∏ñÂ≠êÁöÑËØÑËÆ∫Êï∞\r\n\tPosts.update(comment.postId, {$inc: {commentsCount: 1}});\r\n\treturn Comments.insert(comment);\r\n\t}\r\n});","Posts = new Mongo.Collection('posts');\r\n\r\nPosts.allow({\r\n\t//update: function(userId, post) { return ownsDocument(userId, post); },\r\n\tremove: function(userId, post) { return ownsDocument(userId, post); }\r\n});\r\n\r\n/*\r\nPosts.deny({\r\n\tupdate: function(userId, post, fieldNames) {\r\n\t// Âè™ËÉΩÊõ¥ÊîπÂ¶Ç‰∏ã‰∏§‰∏™Â≠óÊÆµÔºö\r\n\t\treturn (_.without(fieldNames, 'url', 'title').length > 0);\r\n\t}\r\n});\r\n*/\r\nMeteor.methods({\r\n\tpostInsert: function(postAttributes) {\r\n\t\tcheck(Meteor.userId(), String);\r\n\t\tcheck(postAttributes, {\r\n\t\t\ttitle: String,\r\n\t\t\turl: String\r\n\t\t});\r\n\t\t/*\r\n\t\tif (Meteor.isServer) {\r\n\t\t\tpostAttributes.title += \"(server)\";\r\n\t\t\t// wait for 5 seconds\r\n\t\t\tMeteor._sleepForMs(5000);\r\n\t\t} else {\r\n\t\t\tpostAttributes.title += \"(client)\";\r\n\t\t}\r\n\t\t*/\r\n\t\tvar errors = validatePost(postAttributes);\r\n\t\tif (errors.title || errors.url)\r\n\t\t\tthrow new Meteor.Error('invalid-post', \"‰Ω†ÂøÖÈ°ª‰∏∫‰Ω†ÁöÑÂ∏ñÂ≠êÂ°´ÂÜôÊ†áÈ¢òÂíå URL\");\r\n\t\tvar postWithSameLink = Posts.findOne({url: postAttributes.url});\r\n\t\tif (postWithSameLink) {\r\n\t\t\treturn {\r\n\t\t\t\tpostExists: true,\r\n\t\t\t\t_id: postWithSameLink._id\r\n\t\t\t}\r\n\t\t}\r\n\t\tvar user = Meteor.user();\r\n\t\tvar post = _.extend(postAttributes, {\r\n\t\t\tuserId: user._id,\r\n\t\t\tauthor: user.username,\r\n\t\t\tsubmitted: new Date(),\r\n\t\t\tcommentsCount: 0\r\n\t\t});\r\n\t\tvar postId = Posts.insert(post);\r\n\t\treturn {\r\n\t\t\t_id: postId\r\n\t\t};\r\n\t},\r\n\tpostUpdate: function(postAttributes,currentPostId){\r\n\t\tcheck(Meteor.userId(), String);\r\n\t\tcheck(postAttributes, {\r\n\t\t\ttitle: String,\r\n\t\t\turl: String\r\n\t\t});\r\n\t\tvar errors = validatePost(postAttributes);\r\n\t\tif (errors.title || errors.url)\r\n\t\t\tthrow new Meteor.Error('invalid-post', \"‰Ω†ÂøÖÈ°ª‰∏∫‰Ω†ÁöÑÂ∏ñÂ≠êÂ°´ÂÜôÊ†áÈ¢òÂíå URL\");\r\n\t\tvar postWithSameLink = Posts.findOne({url: postAttributes.url,_id:{$ne:currentPostId}});\r\n\t\tif (postWithSameLink) {\r\n\t\t\treturn {\r\n\t\t\t\tpostExists: true,\r\n\t\t\t\t_id: postWithSameLink._id\r\n\t\t\t}\r\n\t\t}\r\n\t\tvar user = Meteor.user();\r\n\t\tvar post = _.extend(postAttributes, {\r\n\t\t\tuserId: user._id,\r\n\t\t\tauthor: user.username,\r\n\t\t\tsubmitted: new Date()\r\n\t\t});\r\n\t\tPosts.update(currentPostId,post);\r\n\t\treturn {\r\n\t\t\t_id: currentPostId\r\n\t\t};\r\n\t}\r\n});\r\n\r\nvalidatePost = function (post) {\r\n\tvar errors = {};\r\n\tif (!post.title)\r\n\t\terrors.title = \"ËØ∑Â°´ÂÜôÊ†áÈ¢ò\";\r\n\tif (!post.url)\r\n\t\terrors.url = \"ËØ∑Â°´ÂÜô URL\";\r\n\treturn errors;\r\n}","// Fixture data\r\nif (Posts.find().count() === 0) {\r\n  var now = new Date().getTime();\r\n  // create two users\r\n  var tomId = Meteor.users.insert({\r\n    profile: { name: 'Tom Coleman' }\r\n  });\r\n  var tom = Meteor.users.findOne(tomId);\r\n  var sachaId = Meteor.users.insert({\r\n    profile: { name: 'Sacha Greif' }\r\n  });\r\n  var sacha = Meteor.users.findOne(sachaId);\r\n  var telescopeId = Posts.insert({\r\n    title: 'Introducing Telescope',\r\n    userId: sacha._id,\r\n    author: sacha.profile.name,\r\n    url: 'http://sachagreif.com/introducing-telescope/',\r\n    submitted: new Date(now - 7 * 3600 * 1000),\r\n    commentsCount: 2\r\n  });\r\n  Comments.insert({\r\n    postId: telescopeId,\r\n    userId: tom._id,\r\n    author: tom.profile.name,\r\n    submitted: new Date(now - 5 * 3600 * 1000),\r\n    body: 'Interesting project Sacha, can I get involved?'\r\n  });\r\n  Comments.insert({\r\n    postId: telescopeId,\r\n    userId: sacha._id,\r\n    author: sacha.profile.name,\r\n    submitted: new Date(now - 3 * 3600 * 1000),\r\n    body: 'You sure can Tom!'\r\n  });\r\n  Posts.insert({\r\n    title: 'Meteor',\r\n    userId: tom._id,\r\n    author: tom.profile.name,\r\n    url: 'http://meteor.com',\r\n    submitted: new Date(now - 10 * 3600 * 1000),\r\n    commentsCount: 0\r\n  });\r\n  Posts.insert({\r\n    title: 'The Meteor Book',\r\n    userId: tom._id,\r\n    author: tom.profile.name,\r\n    url: 'http://themeteorbook.com',\r\n    submitted: new Date(now - 12 * 3600 * 1000),\r\n    commentsCount: 0\r\n  });\r\n}","Meteor.publish('posts', function() {\r\n\treturn Posts.find();\r\n});\r\n\r\nMeteor.publish('comments', function(postId) {\r\n\tcheck(postId, String);\r\n\treturn Comments.find({postId: postId});\r\n});","qiniu = Npm.require(\"qiniu\");\r\n\r\nQN = {\r\n    config: {}\r\n}\r\n\r\nMeteor.startup(function(){\r\n    var has_ak = _.has(QN.config, \"access_key\") && QN.config.access_key;\r\n    var has_sk = _.has(QN.config, \"secret_key\") && QN.config.secret_key;\r\n    var has_bn = _.has(QN.config, \"bucket_name\") && QN.config.bucket_name;\r\n    var has_dn = _.has(QN.config, \"domain_name\") && QN.config.domain_name;\r\n\r\n    if (!has_ak) {\r\n        console.log(\"QN: Qiniu access key is undefined\");\r\n    }\r\n\r\n    if (!has_sk) {\r\n        console.log(\"QN: Qiniu secret key is undefined\");\r\n    }\r\n\r\n    if (!has_bn) {\r\n        console.log(\"QN: Qiniu bucket name is undefined\");\r\n    }\r\n\r\n    if (!has_dn) {\r\n        console.log(\"QN: Qiniu domain name is undefined\");\r\n    }\r\n\r\n    if (!has_ak || !has_sk || !has_bn || !has_dn) {\r\n        return\r\n    }\r\n\r\n    qiniu.conf.ACCESS_KEY = QN.config.access_key;\r\n    qiniu.conf.SECRET_KEY = QN.config.secret_key;\r\n    console.log(\"QN: Qiniu config is successfully defined!\");\r\n\r\n})","qiniu = Npm.require(\"qiniu\");\r\n\r\nQN = {\r\n    config: {}\r\n}\r\n\r\nQN.config = {\r\n    access_key: '4WhOe0LAHRrQ9lK68HuNfUlqD-yL2SK0DWstqBQd',\r\n    secret_key: 'xEB9y7lWOnEuQD-_XR-2tM7hCrof30qV8AKbZDzJ',\r\n    bucket_name: 'lzzh',\r\n    domain_name: 'od2m9k330.bkt.clouddn.com'\r\n}\r\n\r\nMeteor.startup(function(){\r\n    var has_ak = _.has(QN.config, \"access_key\") && QN.config.access_key;\r\n    var has_sk = _.has(QN.config, \"secret_key\") && QN.config.secret_key;\r\n    var has_bn = _.has(QN.config, \"bucket_name\") && QN.config.bucket_name;\r\n    var has_dn = _.has(QN.config, \"domain_name\") && QN.config.domain_name;\r\n\r\n    if (!has_ak) {\r\n        console.log(\"QN: Qiniu access key is undefined\");\r\n    }\r\n\r\n    if (!has_sk) {\r\n        console.log(\"QN: Qiniu secret key is undefined\");\r\n    }\r\n\r\n    if (!has_bn) {\r\n        console.log(\"QN: Qiniu bucket name is undefined\");\r\n    }\r\n\r\n    if (!has_dn) {\r\n        console.log(\"QN: Qiniu domain name is undefined\");\r\n    }\r\n\r\n    if (!has_ak || !has_sk || !has_bn || !has_dn) {\r\n        return\r\n    }\r\n\r\n    qiniu.conf.ACCESS_KEY = QN.config.access_key;\r\n    qiniu.conf.SECRET_KEY = QN.config.secret_key;\r\n    console.log(\"QN: Qiniu config is successfully defined!\");\r\n\r\n})","\r\nvar wrappedPutFile = Meteor.wrapAsync(qiniu.io.putFile, qiniu.io);\r\n\r\nMeteor.methods({\r\n    qn_uptoken: function() {\r\n        var bucket_name = QN.config.bucket_name;\r\n        var putPolicy = new qiniu.rs.PutPolicy(bucket_name);\r\n        return putPolicy.token();\r\n    },\r\n\r\n    qn_delete: function(key) {\r\n        check(key, String);\r\n        console.log(\"server delete call\");\r\n        var client = new qiniu.rs.Client();\r\n        var bucketName = QN.config.bucket_name;\r\n        client.remove(bucketName, key, function(err, ret) {\r\n            if (!err) {\r\n\r\n            } else {\r\n                console.log(err);\r\n            }\r\n        })\r\n    },\r\n\r\n    qn_upload: function(file, key) {\r\n        // check(file, Object);\r\n\r\n        var extra = new qiniu.io.PutExtra();\r\n        var uptoken = Meteor.call('qn_uptoken');\r\n        console.log(\"extra: \" + extra);\r\n        console.log(\"uptoken: \" + uptoken);\r\n\r\n        // server side file is empty\r\n        console.log(\"server file: \");\r\n        console.log(file);\r\n        console.log(\"key: \" + key);\r\n       \r\n        wrappedPutFile(uptoken, key, file, extra);\r\n\r\n    }\r\n})"]}